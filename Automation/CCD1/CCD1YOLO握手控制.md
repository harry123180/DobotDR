# CCD1視覺檢測模組握手控制說明檔案 v5.1 (修正版)

## 概述

CCD1視覺檢測模組YOLOv11版本採用CASE_B/CASE_F/STACK三分類檢測，基於握手式狀態機控制，使用Modbus TCP Client架構連接主服務器(127.0.0.1:502)。

## 基本信息

- **模組名稱**: CCD1視覺檢測模組 YOLOv11版本  
- **基地址範圍**: 200-299 (100個寄存器)
- **檢測類型**: YOLOv11物件檢測
- **檢測對象**: CASE_B, CASE_F, STACK (三種分類)
- **輪詢頻率**: 50ms
- **版本號**: v5.1 (修正版)
- **相機IP**: 192.168.1.8
- **Web介面**: http://localhost:5051

## 修正後寄存器映射表

### 1. 核心控制握手寄存器 (200-206)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 200 | CONTROL_COMMAND | 控制指令 | 0=清空, 8=拍照, 16=拍照+檢測, 32=重新初始化 | R/W |
| 201 | STATUS_REGISTER | 狀態寄存器 | bit0=Ready, bit1=Running, bit2=Alarm, bit3=Initialized | R |
| 202 | MODEL_SELECT | 模型選擇 | 0=未指定, 1-20=模型ID | R/W |
| 203 | CAPTURE_COMPLETE | 拍照完成標誌 | 0=未完成, 1=已完成 | R |
| 204 | DETECT_COMPLETE | 檢測完成標誌 | 0=未完成, 1=已完成 | R |
| 205 | OPERATION_SUCCESS | 操作成功標誌 | 0=失敗, 1=成功 | R |
| 206 | ERROR_CODE | 錯誤代碼 | 0=無錯誤, >0=錯誤代碼 | R |

### 2. YOLOv11檢測參數寄存器 (210-219)

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 | 預設值 |
|------|------|------|----------|------|--------|
| 210 | CONFIDENCE_HIGH | 置信度閾值高位 | 32位置信度×10000高16位 | R/W | 0 |
| 211 | CONFIDENCE_LOW | 置信度閾值低位 | 32位置信度×10000低16位 | R/W | 8000 |
| 212-215 | RESERVED | 保留參數 | 未使用 | R/W | 0 |
| 216-219 | - | 保留區域 | 未使用 | R/W | 0 |

**置信度閾值計算方式**:
- 實際值 = ((CONFIDENCE_HIGH << 16) + CONFIDENCE_LOW) / 10000.0
- 例如: 0.8 → 8000 → HIGH=0, LOW=8000

### 3. YOLOv11檢測結果寄存器 (240-259) 【修正版】

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 240 | CASE_F_COUNT | CASE_F檢測數量 | 0-5 | R |
| 241 | CASE_B_COUNT | CASE_B檢測數量 | 0-255 | R |
| 242 | STACK_COUNT | STACK檢測數量 | 0-255 | R |
| 243 | TOTAL_DETECTIONS | 總檢測數量 | CASE_F + CASE_B + STACK | R |
| 244 | DETECTION_SUCCESS | 檢測成功標誌 | 0=失敗, 1=成功 | R |

### 4. CASE_F座標寄存器 (245-254) 【修正版】

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 245 | CASE_F_1_X | CASE_F 1號 X座標 | 像素座標 | R |
| 246 | CASE_F_1_Y | CASE_F 1號 Y座標 | 像素座標 | R |
| 247 | CASE_F_2_X | CASE_F 2號 X座標 | 像素座標 | R |
| 248 | CASE_F_2_Y | CASE_F 2號 Y座標 | 像素座標 | R |
| 249 | CASE_F_3_X | CASE_F 3號 X座標 | 像素座標 | R |
| 250 | CASE_F_3_Y | CASE_F 3號 Y座標 | 像素座標 | R |
| 251 | CASE_F_4_X | CASE_F 4號 X座標 | 像素座標 | R |
| 252 | CASE_F_4_Y | CASE_F 4號 Y座標 | 像素座標 | R |
| 253 | CASE_F_5_X | CASE_F 5號 X座標 | 像素座標 | R |
| 254 | CASE_F_5_Y | CASE_F 5號 Y座標 | 像素座標 | R |

### 5. 擴展檢測結果寄存器 (255-259) 【新增】

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 255 | CASE_B_1_X | CASE_B 1號 X座標 | 像素座標 | R |
| 256 | CASE_B_1_Y | CASE_B 1號 Y座標 | 像素座標 | R |
| 257 | STACK_1_X | STACK 1號 X座標 | 像素座標 | R |
| 258 | STACK_1_Y | STACK 1號 Y座標 | 像素座標 | R |
| 259 | MODEL_ID_USED | 檢測使用模型ID | 實際使用的模型編號 | R |

### 6. 世界座標寄存器 (260-280) 【修正版】

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 260 | WORLD_COORD_VALID | 世界座標有效標誌 | 0=無效, 1=有效 | R |
| 261 | CASE_F_1_WORLD_X_HIGH | CASE_F 1號世界X座標高位 | 32位世界X座標×100高16位 | R |
| 262 | CASE_F_1_WORLD_X_LOW | CASE_F 1號世界X座標低位 | 32位世界X座標×100低16位 | R |
| 263 | CASE_F_1_WORLD_Y_HIGH | CASE_F 1號世界Y座標高位 | 32位世界Y座標×100高16位 | R |
| 264 | CASE_F_1_WORLD_Y_LOW | CASE_F 1號世界Y座標低位 | 32位世界Y座標×100低16位 | R |
| 265-268 | CASE_F_2_WORLD | CASE_F 2號世界座標 | 同上格式 | R |
| 269-272 | CASE_F_3_WORLD | CASE_F 3號世界座標 | 同上格式 | R |
| 273-276 | CASE_F_4_WORLD | CASE_F 4號世界座標 | 同上格式 | R |
| 277-280 | CASE_F_5_WORLD | CASE_F 5號世界座標 | 同上格式 | R |

### 7. 統計資訊寄存器 (281-299) 【修正版】

| 地址 | 名稱 | 功能 | 數值定義 | 讀寫 |
|------|------|------|----------|------|
| 281 | LAST_CAPTURE_TIME | 最後拍照耗時 | 毫秒單位 | R |
| 282 | LAST_PROCESS_TIME | 最後處理耗時 | 毫秒單位 | R |
| 283 | LAST_TOTAL_TIME | 最後總耗時 | 毫秒單位 | R |
| 284 | OPERATION_COUNT | 操作計數器 | 累積成功次數 | R |
| 285 | ERROR_COUNT | 錯誤計數器 | 累積錯誤次數 | R |
| 286 | CONNECTION_COUNT | 連接計數器 | 累積連接次數 | R |
| 287 | MODEL_SWITCH_COUNT | 模型切換次數 | 累積切換次數 | R |
| 288-289 | - | 保留區域 | 未使用 | R |
| 290 | VERSION_MAJOR | 軟體版本主號 | 5 (YOLOv11版本) | R |
| 291 | VERSION_MINOR | 軟體版本次號 | 0 | R |
| 292 | UPTIME_HOURS | 運行時間小時 | 系統運行時間 | R |
| 293 | UPTIME_MINUTES | 運行時間分鐘 | 系統運行時間 | R |
| 294-299 | - | 保留區域 | 未使用 | R |

## 增強版握手協議操作流程

### 1. 基本握手流程 (修正版)

```
1. 系統初始化完成 → 狀態寄存器201=9 (Ready=1, Initialized=1)
2. PLC下達控制指令200 → 檢查Ready=1
3. 開始執行 → 狀態寄存器201=10 (Ready=0, Running=1, Initialized=1)
4. 執行期間保持Running=1，外部可監控進度
5. 執行完成 → 狀態寄存器201=8 (Running=0, Initialized=1)
6. 設置完成標誌203/204/205=1
7. PLC讀取結果並清零指令200=0
8. 系統檢測到清零 → 狀態寄存器201=9 (Ready=1, Initialized=1)
```

### 2. 拍照+檢測操作序列 (修正版)

```
PLC操作步驟:
1. 檢查狀態寄存器201 bit0=1 (Ready狀態)
2. (可選) 設置模型選擇寄存器202=N (1-20, 0=使用當前模型)
3. 寫入控制指令200=16 (拍照+檢測)
4. 等待拍照完成標誌203=1
5. 等待檢測完成標誌204=1
6. 檢查操作成功標誌205 (1=成功, 0=失敗)
7. 如果成功，讀取檢測結果:
   - 240: CASE_F數量
   - 241: CASE_B數量  
   - 242: STACK數量
   - 245-254: CASE_F座標
   - 255-258: CASE_B和STACK首個座標
   - 259: 使用的模型ID
8. (可選) 讀取世界座標260-280
9. 寫入控制指令200=0 (清零)
10. 等待狀態寄存器201 bit0=1 (Ready恢復)
```

### 3. 模型切換操作

```
PLC操作:
1. 檢查狀態寄存器201 bit0=1 (Ready狀態)
2. 寫入模型選擇寄存器202=N (1-20)
3. 系統自動切換到指定模型
4. 通過寄存器287監控模型切換次數
5. 後續檢測將使用新模型
```

### 4. 錯誤處理和系統重置

```
如果系統異常 (bit2=Alarm=1):
1. 讀取錯誤代碼寄存器206
2. 寫入重新初始化指令200=32
3. 等待系統重新初始化完成
4. 狀態寄存器201恢復正常 (bit2=0)
```

## 典型應用場景

### 場景1: 基本三分類檢測

```python
# PLC Ladder邏輯示例
IF (寄存器201 AND 1) == 1:  # 檢查Ready
    寄存器200 = 16           # 拍照+檢測
    
    # 等待完成
    WAIT_UNTIL 寄存器203 == 1 AND 寄存器204 == 1
    
    IF 寄存器205 == 1:  # 檢查成功
        case_f_count = 寄存器240    # CASE_F數量
        case_b_count = 寄存器241    # CASE_B數量
        stack_count = 寄存器242     # STACK數量
        total_count = 寄存器243     # 總數量
        
        IF case_f_count > 0:
            case_f_1_x = 寄存器245  # 第一個CASE_F的X座標
            case_f_1_y = 寄存器246  # 第一個CASE_F的Y座標
        
        used_model = 寄存器259      # 檢測使用的模型ID
    
    寄存器200 = 0            # 清零指令
```

### 場景2: 動態模型切換檢測

```python
# 使用模型5進行檢測
IF (寄存器201 AND 1) == 1:  # 檢查Ready
    寄存器202 = 5            # 選擇模型5
    寄存器200 = 16           # 拍照+檢測
    
    # 等待完成並讀取結果
    WAIT_UNTIL 寄存器204 == 1
    IF 寄存器205 == 1:
        results = 讀取寄存器240-259
        確認使用的模型 = 寄存器259  # 應該是5
    
    寄存器200 = 0            # 清零指令
```

### 場景3: 世界座標獲取 (修正版)

```python
# 獲取CASE_F的世界座標
IF 寄存器260 == 1:  # 檢查世界座標有效
    FOR i = 1 TO case_f_count:
        base_addr = 261 + (i-1)*4  # 每個CASE_F佔4個寄存器
        
        # 讀取32位世界座標
        world_x_high = 寄存器[base_addr]
        world_x_low = 寄存器[base_addr+1]  
        world_y_high = 寄存器[base_addr+2]
        world_y_low = 寄存器[base_addr+3]
        
        # 組合並轉換為實際座標
        world_x_int = (world_x_high << 16) + world_x_low
        world_y_int = (world_y_high << 16) + world_y_low
        
        # 處理負數 (補碼轉換)
        IF world_x_int >= 32768:
            world_x_int = world_x_int - 65536
        IF world_y_int >= 32768:
            world_y_int = world_y_int - 65536
            
        # 轉換為毫米
        world_x_mm = world_x_int / 100.0
        world_y_mm = world_y_int / 100.0
```

## 狀態機詳細說明

### 狀態寄存器201位定義

| 位 | 名稱 | 含義 | 說明 |
|----|------|------|------|
| 0 | Ready | 就緒狀態 | 1=可接受新指令, 0=忙碌中 |
| 1 | Running | 執行狀態 | 1=正在執行指令, 0=空閒 |
| 2 | Alarm | 警報狀態 | 1=系統異常, 0=正常 |
| 3 | Initialized | 初始化狀態 | 1=已初始化, 0=未初始化 |

### 常見狀態值對照表

| 十進制值 | 二進制 | 狀態描述 | 處理建議 |
|----------|--------|----------|----------|
| 0 | 0000 | 系統未初始化 | 等待系統啟動 |
| 1 | 0001 | Ready但未初始化 | 異常狀態，需檢查 |
| 8 | 1000 | 已初始化但未Ready | 等待Ready |
| 9 | 1001 | Ready+Initialized | 正常待機，可下指令 |
| 10 | 1010 | Running+Initialized | 正在執行，請等待 |
| 12 | 1100 | Alarm+Initialized | 系統異常，需重置 |

### 錯誤代碼定義 (寄存器206)

| 錯誤代碼 | 含義 | 解決方法 |
|----------|------|----------|
| 0 | 無錯誤 | 正常狀態 |
| 1 | 視覺控制器不存在 | 重新初始化系統 |
| 2 | 系統未Ready | 等待Ready或重置 |
| 3 | 未知控制指令 | 檢查指令代碼 |
| 10 | 模型切換錯誤 | 檢查模型ID有效性 |
| 11 | 無效模型ID | 使用1-20範圍內的模型ID |
| 20 | 檢測失敗 | 檢查相機連接和目標物體 |
| 30 | 初始化失敗 | 檢查相機IP和網路連接 |
| 99 | 執行異常 | 查看詳細日誌，重新初始化 |

## 性能與限制

### 性能指標
- **檢測速度**: 通常 < 300ms (拍照+YOLOv11檢測)
- **握手響應**: 50ms輪詢頻率  
- **置信度範圍**: 0.1-1.0 (建議0.6-0.95)
- **最大檢測數量**: CASE_F=5個, CASE_B/STACK=1個座標輸出
- **模型切換**: 支援1-20個模型動態切換
- **座標精度**: 像素級 + 0.01mm世界座標

### 系統限制
- 單相機模式 (192.168.1.8)
- 需要YOLOv11模型檔案 (model_1.pt ~ model_20.pt)
- 需要標定檔案才能提供世界座標
- Modbus TCP Client模式，需要外部服務器

## 故障診斷

### 常見問題檢查清單

1. **指令不響應**
   - 檢查狀態寄存器201 bit0=1 (Ready)
   - 確認Modbus TCP連接正常
   - 確認握手同步線程運行中

2. **檢測失敗**
   - 檢查錯誤代碼寄存器206
   - 調整置信度閾值210-211
   - 確認模型檔案存在

3. **世界座標無效**
   - 檢查寄存器260=0
   - 確認標定檔案已載入
   - 通過Web介面檢查標定狀態

4. **模型切換失敗**
   - 確認模型ID在1-20範圍內
   - 檢查模型檔案是否存在
   - 查看寄存器287的切換計數

### 系統重置步驟

```
1. 寫入重新初始化指令: 寄存器200 = 32
2. 等待處理完成: 監控狀態寄存器201
3. 檢查錯誤清除: 寄存器206 = 0
4. 確認Ready狀態: 寄存器201 bit0 = 1
5. 系統恢復正常使用
```

## Web介面支援

- **訪問地址**: http://localhost:5051
- **功能**: 即時狀態監控、參數調整、模型切換
- **寄存器監控**: 實時顯示所有寄存器數值
- **檢測結果**: 視覺化顯示檢測結果
- **標定管理**: 內外參檔案載入和管理

## 版本更新記錄

### v5.1 (修正版) - 2024-12
- **修正**: 寄存器地址映射與程式碼對齊
- **新增**: STACK分類檢測支援  
- **新增**: 多模型動態切換功能
- **新增**: 增強版握手協議
- **修正**: 完成標誌寄存器203-206
- **新增**: 模型管理寄存器202和287
- **優化**: 錯誤處理和狀態機邏輯

### v5.0 (YOLOv11版本)
- 完全移除圓形檢測功能
- 新增YOLOv11 CASE_B/CASE_F分類檢測  
- 重新設計寄存器映射表
- 僅輸出CASE_F座標值
- 置信度閾值可通過寄存器控制
- 保留世界座標轉換功能
- 優化握手協議響應速度